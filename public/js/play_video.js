$(function(){$('div[contenteditable]').keydown(function(e){if(e.keyCode===13){document.execCommand('insertHTML',false,'<br><br>');return false;}});let video=document.querySelector('video');let bar=document.querySelector('input[id^="plyr-seek"]');let thumb=document.getElementById('thumb');let track=video.textTracks[0];let cues=track.cues;
    function show(){thumb.style.visibility='visible';};
    function hide(){thumb.style.visibility='hidden';};
    function getOffset(el){const rect=el.getBoundingClientRect();return{left:rect.left+window.scrollX,top:rect.top+window.scrollY};}
    function render(e){let bar_width=bar.offsetWidth;if(!cues.length){return;}
        var p=(e.pageX-getOffset(bar).left)*video.duration/bar_width;for(var i=0;i<cues.length;i++){if(cues[i].startTime<=p&&cues[i].endTime>p){break;};}
        var xywh=cues[i].text.substr(cues[i].text.indexOf("=")+1).split(',');thumb.style.backgroundImage='url(../../storage/app/uploads/formatted/'+cues[i].text.split('#')[0]+')';thumb.style.backgroundPosition='-'+xywh[0]+'px -'+xywh[1]+'px';thumb.style.left=e.pageX-xywh[2]/2+'px';thumb.style.top=getOffset(bar).top-xywh[3]-10+'px';thumb.style.width=xywh[2]+'px';thumb.style.height=xywh[3]+'px';};bar.addEventListener('mousemove',render);bar.addEventListener('mouseover',show);bar.addEventListener('mouseout',hide);twemoji.parse(document.body,{base:"../twemoji/"});$('#emoji').on('click',function(){$('.emoji-list').toggle(100);})
    $('#emoji').on('blur',function(){$('.emoji-list').hide(100);})
    $('.emoji-list li').on('mousedown',function(){let value=$('#comment-text').val();$('#comment-text').append($(this).children().clone());});Number.prototype.padLeft=function(base,chr){var len=(String(base||10).length-String(this).length)+1;return len>0?new Array(len).join(chr||'0')+this:this;}
    var date=new Date,dformat=[(date.getMonth()+1).padLeft(),date.getDate().padLeft(),date.getFullYear()].join('/')+' '+
        [date.getHours().padLeft(),date.getMinutes().padLeft(),date.getSeconds().padLeft()].join(':');$('#result').html(dformat);let publish=document.querySelector('#publish');publish.addEventListener('click',function(){if(window.id&&window.name){let comment=$.trim($('#comment-text')[0].innerHTML.replace(/<img.*?alt="(.{1,4})".*?>/g,'$1').replace(/&nbsp;/g,' '));if(comment!==''&&comment.length<=65535){$.ajaxSetup({headers:{'X-CSRF-TOKEN':$('meta[name="csrf-token"]').attr('content')}});$.ajax({method:'post',data:{comment},success:function(){$('.tip').remove();$('#comment-text')[0].innerHTML='';$(document.body).prepend('<span class="tip">发送成功</span>');let date=new Date(),dformat=[date.getFullYear(),(date.getMonth()+1).padLeft(),date.getDate().padLeft()].join('-')+' '+
            [date.getHours().padLeft(),date.getMinutes().padLeft(),date.getSeconds().padLeft()].join(':');const newlyComment=$('<div class="comment clearfix"> <div class="comment-title"> <img src='+`../../storage/app/${window.avatar}`+' width="50" height="50" class="comment-avatar rounded-circle"> <div class="comment-info"> <strong class="commentator">'+name+'</strong> <span class="comment-time">'+dformat+'</span> </div></div><div class="comment-body"> <span class="comment-content">'+comment+'</span></div><div class="comment-footer float-right"> <button class="btn btn-primary mr-1"><i class="fa fa-thumbs-up" aria-hidden="true"></i>0</button> <button class="btn btn-danger"><i class="fa fa-thumbs-down" aria-hidden="true"></i>0</button> </div></div>');twemoji.parse(newlyComment[0],{base:"../twemoji/"});$('.grid').prepend(newlyComment).masonry('prepended',newlyComment);},error:function(err){if(err.status===401){$('.tip').remove()
            $(document.body).prepend('<span class="tip bg-info">您还没登录，请先登录再评论</span>');}else{$('.tip').remove()
            $(document.body).prepend('<span class="tip bg-info">服务器内部错误，请稍后再试</span>');}},})}else if(comment===''){$('.tip').remove()
        $(document.body).prepend('<span class="tip bg-info">评论不能为空</span>')}else{$('.tip').remove()
        $(document.body).prepend('<span class="tip">评论字数（含表情）不能超过65535个字符</span>')}}else{$('.tip').remove()
        $(document.body).prepend('<span class="tip bg-info">您还没登录，请先登录再评论</span>');}});$('.grid').masonry({itemSelector:'.comment',columnWidth:'.comment',percentPosition:true,gutter:10});})